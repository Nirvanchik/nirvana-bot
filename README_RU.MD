# Бот NirvanaBot
## Назначение
NirvanaBot - бот для обновления различных списков в порталах и проектах
Википедии. Типичные виды обновляемых списков:
 - списки новых статей, новых категорий, новых шаблонов по теме;
 - списки новых статей с иллюстрациями по теме;
 - списки наблюдения за категорией;
 - списки избранных, хороших, добротных статей и кандидатов по теме;
 - списки статей под обсуждением по теме (к улучшению, к удалению, к
  переименованию и др.);
 - списки статей с замечаниями по теме(шаблон rq).

"По теме" здесь означает, что статьи списка отобраны по теме портала или
проекта, при помощи указания определенных категорий, по которым бот ищет
статьи в данной теме.
Другие подробности см. здесь:
[Участник:NirvanaBot](https://ru.wikipedia.org/wiki/Участник:NirvanaBot).

## Как запускать
Для каждой цели запуска бота есть свой отдельный скрипт запуска. Все скрипты
почти не отличаются друг от друга, единственное отличие - это разные 
XML-конфиги, подставляемые в командную строку запуска бота. Типичный скрипт
запуска (для Windows) выглядит так:
```
chcp 866
java -jar target/nirvana-bot-full.jar config.xml
```
Команда "chcp" устанавливает текущую кодировку символов в консоли (такую же
кодировку устанавливает бот для вывода своих логов, через конфигурацию log4j2).
Это позволяет видеть русские (кириллические) тексты, выводимые в консоль при
работе бота (вместо непонятных кракозябр). Это никак не влияет на кодировку
логов, все логи пишутся в кодировке UTF-8.
config.xml - файл конфигурации, где бот считает свои параметры, прежде чем
начать работу.
### Скрипты для запуска
Полный запуск:
* `all.cmd` - запускает бота на русскую и белорусскую вики (по очереди). Сейчас
не используется;

Основная группа скриптов для регулярного запуска:
* `allru.cmd` - запускает бота на русскую вики;
* `nirvanabe.cmd` - запускает бота на белорусскую вики;
* `run_uk.cmd` - запускает бота на украинскую вики.

Эти 3 скрипта можно запускать одновременно, они не будут мешать друг другу.

* `nirvana-2.cmd` - утренний запуск бота в русской вики. Утренний запуск - это 
частичный (не полный) запуск бота, предназначенный только для списков, которые
нужно обновлять дважды в сутки (как правило это самые активные списки, 40+
статей в сутки).

`allru.cmd` - назван словом `all`, а не словом nirvana, потому что это изнутри
пока двойной бот, бот "два в одном". Один из них - это реинкарнированный
ClaymoreBot, работающий по старому шаблону 
[Участник:ClaymoreBot/Новые_статьи](https://ru.wikipedia.org/wiki/Участник:ClaymoreBot/Новые_статьи).
Здесь NirvanaBot работает в режиме совместимости со старым шаблоном.
Теоретически, старый ClaymoreBot всё ещё может обработать эти списки,
хотя практически это уже вряд ли возможно (бота надо исправлять).
Другой из них - это новый NirvanaBot, работающий по новому шаблону
[Участник:NirvanaBot/Новые_статьи](https://ru.wikipedia.org/wiki/Участник:NirvanaBot/Новые_статьи).
Новый шаблон мощнее, современнее, содержит множество новых свойств, параметров,
и сам шаблон умнее и удобнее в использовании, списки с новым шаблоном может
обработать только NirvanaBot, так как там исользуются
уникальные возможности этого бота. Происходит постепенный переезд на этот
новый шаблон.

Вышеуказанные скрипты можно запускать как локально, со своего компьютера 
(для эксперимента), так и на сервере, по расписанию.
Внимание, `all.cmd` и `allru.cmd` - долгие (5+ часов).

Остальные скрипты - это или отладочные скрипты (`debug.cmd`), или скрипты для
выполнения некоторых разовых заданий (`task.cmd`).

## Настройка бота
### Основные настройки
TODO
### Как отлаживаться
Бывает, что хочется проверить работу бота, не запуская бота реально (чтобы бот
не делал реальные правки в Википедии), или бывает, хочется проверить бота
на обновлении одного конкретного списка. Для этого у бота есть ряд отладочных
параметров:
 - `debug-mode` (`yes`/`no`) - если включить эту настройку, бот будет делать
 свою обычную работу, но не будет делать реальные правки в Википедии, вместо этого,
 бот сохранит дампы всех правок (старую и новую версию страницы). Дампы хранятся
 в папке "/out/ru/dump" ("/out/<lang>/dump", если быть честным).
 - `start-from` (число, 0 и выше) - бот пропустит N первых списков и начнёт
 обработку списков начиная с указанного номера.
 - `type` - какие типы списков обновлять. Если указать "all", будет обновлять все.
 Можно указать через запятую отдельные типы (без кавычек).
 - `fast-mode` (`yes`/`no`) - позволяет глобально включать/выключать быстрый режим
 (по умолчанию включен).
 - `service` - сервис, который будет использовать бот для извлечения списков.
 Здесь нужно или указать точное название сервиса, или слово "auto" (автоматический
 выбор сервиса из списка доступных).
 - `default-service` - сервис по-умолчанию. Используется для указания основного
 сервиса для режима "auto". В режиме "auto" бот будет всегда стараться выбирать
 этот сервис, и только когда он не доступен, будет переключаться на другие сервисы.
 - `task-list` (`yes`/`no`) - если включить, бот будет обновлять только те проекты
 или порталы, которые указаны в списке, сам список должен быть в отдельном файле,
 а путь к файлу указан в параметре `task-list-file`.
 Полное совпадение названия не обязательно, достаточно чтобы совпадало начало. 
 Например, если я укажу в списке "Проект:Астрономия", то бот обновит 3 списка:
 "Проект:Астрономия/К удалению/Параметры", "Проект:Астрономия/К улучшению/Параметры",
 "Проект:Астрономия/Новые статьи/Параметры".
 - `long-task`, `update-limit` - какие-то устаревшие, неиспользуемые параметры.

 Для отладки лучше использовать скрипты, настроенные на отдельные отладочные
 конфигурации (скрипты debug.cmd, debug_be.cmd, debug_uk.cmd, task.cmd, и др.).
 
### Авторизация бота
Для авторизации бота используется отдельный xml-файл, с логином/паролем для
авторизации (loginNirvanaBot.xml). Пример такого xml-файла см. в
[loginUserExample.xml](loginUserExample.xml). Привязать этот файл к
конфигурации бота можно при помощи параметра `wiki-account-file`,
в котором указывается путь к этому xml.

Также, для авторизации можно использовать параметры `wiki-login` и
`wiki-password` в основной конфигурации, но так делать не рекомендуется.

# Бот CleanArchiveBot
## Назначение
CleanArchiveBot предназначен для чистки архивов новых статей от ненужных
статей - статей, не относящихся к главной теме данного портала или проекта. Как
правило, это нужно для исправления статистики, удаления из рейтинга случайно
попавших туда авторов.

## Как пользоваться
### Список ненужных статей
Сначала нужно собрать список ненужных статей. Я для этого использую сервис
http://petscan.wmflabs.org/. Указываю язык (language) ru, глубину (depth) - 
высчитываю по формуле:
```
  глубина = <глубина корневой категории проекта (обычно 6)> - 
            <глубина от корневой категории до категории, которую надо
            заигнорировать>.
```
К примеру в Биологии у меня было так (вырезали категорию Умершие):
```
  глубина (Умершие) = 7 - 2 = 5.
```
В Categories указываю категории, которые нужно заигнорировать (в которых лежат
статьи не по теме), в Negative categories указываю подкатегории, в которых
встречаются статьи по теме, в Output указывают формат TSV.
В результате, получаю список, который выглядит примерно так:
```
number	title	pageid	namespace	length	touched
1	Кавказские_Минеральные_Воды	30		80443	20180616170834
2	Санкт-Петербург	45		302800	20180616210327
3	Шартр	53		7574	20180616170834
...
```
Но можно собрать список любым другим сервисом (pywikibot, AWB, и др.) в обычный
список в текстовом файле (название каждой статьи должно идти с новой строки).

### Создание файла задачи
Файл задачи - это текстовый файл, в котором описаны основные сведения, по
которым бот будет выполнять задачу. Этот файл внутри себя похож на обычный
INI-файл. Разберём файл задачи на примере Биологии:
```
список плохих статей = bad_pages.txt
архив = Портал:Биология/Новые статьи/Архив/
разделитель = \n
формат = tsv
метод = 3
редиректы = нет
```
* Параметр `список плохих статей` - это имя файла в котором лежит список плохих
  статей. Любые статьи из этого списка, которые попадутся в архивах, будут
  удалены из архивов.
* `архив` - вики-ссылка на архив, а если архивов много (архивы разбиты по
  годам, например), то начало названия архивов, общий для них префикс. По этому
  префиксу бот найдет архивы, и отличит их от неархивов.
* `разделитель` - разделитель строк со статьями в архиве.
* `формат` - это формат файла, в котором дан список плохих статей. Возможны
  значения: tsv, txt.
* `метод` - выбор метода, которым бот будет отыскивать плохие статьи. Здесь
  возможны три значения: 1, 2, 3. Самый быстрый способ - 3.
* `редиректы` - должен ли бот отыскивать статьи, которые были переименованы (в
  архиве вики-ссылка будет указывать на редирект). Возможны значения: да, нет.
  Значение "нет" полезно, если хочется прогнать бота максимально быстро. С
  редиректами бот будет работать долго.

### Запуск бота
Указываем в конфигурации бота "config_clean_archive.xml" файл задачи:
```xml
<entry key="task-file">clean_archive_task.txt</entry>
``` 
Если нужно посмотреть, что сделает бот, но не вносить правки, указываем debug
mode = yes, а если по настоящему запустить, тогда no:
```xml
<entry key="debug-mode">no</entry>
```
Запускаем бота:
```
clean_archive.cmd
```
Смотрим результат в Википедии, или в папке дампов (/out/ru/dump).